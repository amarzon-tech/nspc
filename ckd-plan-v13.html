<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta charset="UTF-8">
  <title>Kidney Care Plan (v13)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js?v=20250809v13"></script>

<script>
const forceGrayPlugin = {
  id: 'forceGrayPlugin',
  beforeUpdate(chart) {
    const id = chart.canvas && chart.canvas.id;
    if (id === 'uacrChart' || id === 'creatinineChart') {
      (chart.config.data.datasets || []).forEach(ds => {
        ds.borderColor = '#000';
        ds.backgroundColor = 'rgba(0,0,0,0.08)';
        ds.pointBackgroundColor = '#000';
        ds.pointBorderColor = '#000';
      });
      chart.options.scales = chart.options.scales || {};
      const sx = chart.options.scales.x = chart.options.scales.x || {};
      const sy = chart.options.scales.y = chart.options.scales.y || {};
      sx.ticks = Object.assign({ font: { size: 14 } }, sx.ticks || {}, { color: '#666' });
      sx.grid  = Object.assign({}, sx.grid || {}, { color: '#aaa' });
      sy.ticks = Object.assign({}, sy.ticks || {}, { color: '#666' });
      sy.grid  = Object.assign({}, sy.grid || {}, { color: '#aaa' });
      sy.title = Object.assign({}, sy.title || {}, { display: true, color: '#666' });
      chart.options.plugins = chart.options.plugins || {};
      chart.options.plugins.legend = chart.options.plugins.legend || {};
      chart.options.plugins.legend.labels = Object.assign({}, chart.options.plugins.legend.labels || {}, { color: '#666' });
      chart.options.animation = false;
    }
  }
};
function __reg(){ if (window.Chart && Chart.register) { Chart.register(forceGrayPlugin); } else { setTimeout(__reg, 100); } } __reg();
</script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js?v=20250809v13"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7fbfd; margin: 20px; }
    h1 { text-align: center; color: #2c3e50; }
    input, select, textarea, button {
      width: 100%; padding: 8px; margin: 6px 0; font-size: 14px;
    }
    label { font-weight: bold; display: block; margin-top: 10px; }
    .chart-container { width: 100%; margin-top: 20px; background: #fff; border-radius: 8px; }
    canvas { background: #fff; border-radius: 8px; height: 200px !important; }
    .inline { display: flex; flex-wrap: wrap; gap: 10px; }
    .inline label { flex: 1 0 200px; }
    #heatmapTable { border-collapse: collapse; margin-top: 20px; width: 100%; }
    #heatmapTable td, #heatmapTable th {
      padding: 6px; text-align: center; border: 1px solid #aaa; font-weight: bold;
    }
    .green { background-color: #b6ffb6; }
    .yellow { background-color: #fff79a; }
    .orange { background-color: #ffc78a; }
    .red { background-color: #ff7b7b; }
    #exportBtn { background: #3498db; color: white; font-size: 16px; margin-top: 20px; }
  </style>
</head>
<body>
<img src="nspc-logo.png?v=20250809v13?v=20250809v13" alt="NSPC Logo" style="width:180px; display:block; margin:10px auto 0;" />
<h1>Kidney Care Plan</h1>

<label>Patient Name</label>
<input type="text" id="name" placeholder="Enter full name" />
<label>Date</label>
<input type="date" id="date" />

<label>Paste Lab Notes or Text</label>
<textarea id="labInput" rows="6" placeholder="e.g. 06/01/2024 - creatinine 1.2, GFR 57, UACR 120..."></textarea>
<button onclick="parseAndPlot()">Parse and Plot Charts</button>

<div id="parsedSummary" style="font-weight:bold; margin:10px 0;"></div>
<div id="diag" style="font-size:12px;color:#555;margin:6px 0;"></div>
<div id="err" style="font-size:12px;color:#c00;margin:6px 0;"></div>
<div class="chart-container"><canvas id="gfrChart"></canvas></div>
<div class="chart-container"><canvas id="creatinineChart"></canvas></div>
<div class="chart-container"><canvas id="uacrChart"></canvas></div>

<h3>KDIGO Risk Heat Map (Patient Cell Arrow)</h3>
<table id="heatmapTable">
  <tr><th>UACR ↓ / GFR →</th><th>≥ 90</th><th>60–89</th><th>45–59</th><th>30–44</th><th>15–29</th><th>&lt;15</th></tr>
  <tr><th>&lt; 30 (A1)</th><td class="green">G1A1</td><td class="green">G2A1</td><td class="yellow">G3aA1</td><td class="yellow">G3bA1</td><td class="orange">G4A1</td><td class="red">G5A1</td></tr>
  <tr><th>30–300 (A2)</th><td class="yellow">G1A2</td><td class="yellow">G2A2</td><td class="orange">G3aA2</td><td class="orange">G3bA2</td><td class="red">G4A2</td><td class="red">G5A2</td></tr>
  <tr><th>&gt; 300 (A3)</th><td class="orange">G1A3</td><td class="orange">G2A3</td><td class="red">G3aA3</td><td class="red">G3bA3</td><td class="red">G4A3</td><td class="red">G5A3</td></tr>
</table>

<h3>Follow-up Plan</h3>
<p>Continue kidney protective medications</p>
<div class="inline">
  <label>Follow-up Visit In:
    <select id="visitFollowup">
      <option value="1 month">1 month</option>
      <option value="2 months">2 months</option>
      <option value="3 months">3 months</option>
      <option value="6 months">6 months</option>
    </select>
  </label>
  <label>Repeat labs in:
    <select id="repeatLabs">
      <option value="1 month">1 month</option>
      <option value="2 months">2 months</option>
      <option value="3 months">3 months</option>
      <option value="6 months">6 months</option>
    </select>
  </label>
  <label>Vitamin D:
    <select id="vitaminD">
      <option value="2000 units">2000 units</option>
      <option value="5000 units">5000 units</option>
      <option value="Prescribed">Prescribed</option>
    </select>
  </label>
  <label>Salt Restriction:
    <select id="saltRestriction">
      <option value="2 gm or less">2 gm or less</option>
      <option value="Liberalized">Liberalized</option>
    </select>
  </label>
  <label>Fluid Restriction:
    <select id="fluidRestriction">
      <option value="42 oz">42 oz</option>
      <option value="60 oz">60 oz</option>
      <option value="No limit">No limit</option>
    </select>
  </label>
  <label>Potassium Restriction:
    <select id="kRestriction">
      <option value="< 3 gm">&lt; 3 gm</option>
      <option value="No limit">No limit</option>
    </select>
  </label>
</div>

<button id="exportBtn" onclick="exportToPDF()">Export to PDF</button>


<script>
const backgroundBands = {
  id: 'ckdBands',
  beforeDraw: (chart) => {
    const ctx = chart.ctx;
    const yAxis = chart.scales.y;
    const chartArea = chart.chartArea;
    const zones = [
      { min: 0, max: 15, color: '#cc0000' },     // Stage 5
      { min: 15, max: 30, color: '#ff6666' },    // Stage 4
      { min: 30, max: 45, color: '#ffc78a' },    // Stage 3b
      { min: 45, max: 60, color: '#fff79a' }     // Stage 3a
    ];
    zones.forEach(zone => {
      const yTop = yAxis.getPixelForValue(zone.max);
      const yBottom = yAxis.getPixelForValue(zone.min);
      ctx.save();
      ctx.fillStyle = zone.color;
      ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBottom - yTop);
      ctx.restore();
    });
  }
};

Chart.register(backgroundBands);
</script>

<script>
let gfrChart, uacrChart, creatinineChart;


function parseAndPlot() {
  let raw = document.getElementById("labs").value || "";
  // Normalize unicode dashes/spaces
  raw = raw.replace(/[\u2013\u2014]/g, '-').replace(/\u00A0/g, ' ');
  const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

  // Collect by date so we can merge lines like "UACR only" or "Cr + GFR"
  const byDate = new Map();

  const dateRe = /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/; // 8/21/2024 or 11-20-2023
  const gfrRe = /gfr\s*[:=\-]?\s*(\d{1,3})\b/i;
  const uacrRe = /\b(?:uacr|acr)\s*[:=\-]?\s*(\d{1,5})\b/i;
  const crRe = /\b(?:creatinine|cr)\s*[:=\-]?\s*(\d{1,2}(?:\.\d+)?)\b/i;

  lines.forEach(line => {
    const d = line.match(dateRe);
    if (!d) return;
    let [_, mm, dd, yy] = d;
    if (yy.length === 2) yy = (Number(yy) < 50 ? "20" : "19") + yy; // 2-digit year guard
    const dateKey = `${mm.padStart(2,"0")}/${dd.padStart(2,"0")}/${yy}`;

    const g = line.match(gfrRe);
    const a = line.match(uacrRe);
    const c = line.match(crRe);

    const prev = byDate.get(dateKey) || {};
    if (g) prev.gfr = Number(g[1]);
    if (a) prev.uacr = Number(a[1]);
    if (c) prev.creat = Number(c[1]);
    byDate.set(dateKey, prev);
  });

  // Sort dates ascending
  const keys = Array.from(byDate.keys()).sort((a,b)=> {
    const [am,ad,ay] = a.split("/").map(Number);
    const [bm,bd,byr] = b.split("/").map(Number);
    return new Date(ay,am-1,ad) - new Date(byr,bm-1,bd);
  });

  const dates = [];
  const gfrs = [], uacrs = [], creats = [];

  keys.forEach(k => {
    const rec = byDate.get(k) || {};
    dates.push(k);
    gfrs.push(rec.gfr != null ? Number(rec.gfr) : null);
    uacrs.push(rec.uacr != null ? Number(rec.uacr) : null);
    creats.push(rec.creat != null ? Number(rec.creat) : null);
  });

  // Show parsed summary + diagnostics
  const summary = `Parsed ${keys.length} dates`;
  document.getElementById("parsedSummary").innerText = summary;
  const diag = document.getElementById("diag");
  if (diag) diag.innerText = `Parsed: GFR ${gfrs.filter(v=>v!=null).length} | UACR ${uacrs.filter(v=>v!=null).length} | Cr ${creats.filter(v=>v!=null).length}`;
const totalPts = gfrs.filter(v=>v!=null).length + uacrs.filter(v=>v!=null).length + creats.filter(v=>v!=null).length;
const err = document.getElementById("err"); if (err) err.textContent = totalPts ? "" : "No parsable values found. Try formats like: 8/21/2024 UACR 24, Cr 1.4, GFR 54";

  plotCharts(dates, gfrs, uacrs, creats);
}

</script>

</body>
</html>