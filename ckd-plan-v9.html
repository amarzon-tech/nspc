<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta charset="UTF-8">
  <title>Kidney Care Plan (v9)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js?v=20250809v9"></script>

<script>
const forceGrayPlugin = {
  id: 'forceGrayPlugin',
  beforeUpdate(chart) {
    const id = chart.canvas && chart.canvas.id;
    if (id === 'uacrChart' || id === 'creatinineChart') {
      (chart.config.data.datasets || []).forEach(ds => {
        ds.borderColor = '#000';
        ds.backgroundColor = 'rgba(0,0,0,0.08)';
        ds.pointBackgroundColor = '#000';
        ds.pointBorderColor = '#000';
      });
      chart.options.scales = chart.options.scales || {};
      const sx = chart.options.scales.x = chart.options.scales.x || {};
      const sy = chart.options.scales.y = chart.options.scales.y || {};
      sx.ticks = Object.assign({ font: { size: 14 } }, sx.ticks || {}, { color: '#666' });
      sx.grid  = Object.assign({}, sx.grid || {}, { color: '#aaa' });
      sy.ticks = Object.assign({}, sy.ticks || {}, { color: '#666' });
      sy.grid  = Object.assign({}, sy.grid || {}, { color: '#aaa' });
      sy.title = Object.assign({}, sy.title || {}, { display: true, color: '#666' });
      chart.options.plugins = chart.options.plugins || {};
      chart.options.plugins.legend = chart.options.plugins.legend || {};
      chart.options.plugins.legend.labels = Object.assign({}, chart.options.plugins.legend.labels || {}, { color: '#666' });
      chart.options.animation = false;
    }
  }
};
if (window.Chart && Chart.register) { Chart.register(forceGrayPlugin); }
</script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js?v=20250809v9"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7fbfd; margin: 20px; }
    h1 { text-align: center; color: #2c3e50; }
    input, select, textarea, button {
      width: 100%; padding: 8px; margin: 6px 0; font-size: 14px;
    }
    label { font-weight: bold; display: block; margin-top: 10px; }
    .chart-container { width: 100%; margin-top: 20px; background: #fff; border-radius: 8px; }
    canvas { background: #fff; border-radius: 8px; height: 200px !important; }
    .inline { display: flex; flex-wrap: wrap; gap: 10px; }
    .inline label { flex: 1 0 200px; }
    #heatmapTable { border-collapse: collapse; margin-top: 20px; width: 100%; }
    #heatmapTable td, #heatmapTable th {
      padding: 6px; text-align: center; border: 1px solid #aaa; font-weight: bold;
    }
    .green { background-color: #b6ffb6; }
    .yellow { background-color: #fff79a; }
    .orange { background-color: #ffc78a; }
    .red { background-color: #ff7b7b; }
    #exportBtn { background: #3498db; color: white; font-size: 16px; margin-top: 20px; }
  </style>
</head>
<body>
<img src="nspc-logo.png?v=20250809v9?v=20250809v9" alt="NSPC Logo" style="width:180px; display:block; margin:10px auto 0;" />
<h1>Kidney Care Plan</h1>

<label>Patient Name</label>
<input type="text" id="name" placeholder="Enter full name" />
<label>Date</label>
<input type="date" id="date" />

<label>Paste Lab Notes or Text</label>
<textarea id="labInput" rows="6" placeholder="e.g. 06/01/2024 - creatinine 1.2, GFR 57, UACR 120..."></textarea>
<button onclick="parseAndPlot()">Parse and Plot Charts</button>

<div id="parsedSummary" style="font-weight:bold; margin:10px 0;"></div>
<div class="chart-container"><canvas id="gfrChart"></canvas></div>
<div class="chart-container"><canvas id="creatinineChart"></canvas></div>
<div class="chart-container"><canvas id="uacrChart"></canvas></div>

<h3>KDIGO Risk Heat Map (Patient Cell Arrow)</h3>
<table id="heatmapTable">
  <tr><th>UACR ↓ / GFR →</th><th>≥ 90</th><th>60–89</th><th>45–59</th><th>30–44</th><th>15–29</th><th>&lt;15</th></tr>
  <tr><th>&lt; 30 (A1)</th><td class="green">G1A1</td><td class="green">G2A1</td><td class="yellow">G3aA1</td><td class="yellow">G3bA1</td><td class="orange">G4A1</td><td class="red">G5A1</td></tr>
  <tr><th>30–300 (A2)</th><td class="yellow">G1A2</td><td class="yellow">G2A2</td><td class="orange">G3aA2</td><td class="orange">G3bA2</td><td class="red">G4A2</td><td class="red">G5A2</td></tr>
  <tr><th>&gt; 300 (A3)</th><td class="orange">G1A3</td><td class="orange">G2A3</td><td class="red">G3aA3</td><td class="red">G3bA3</td><td class="red">G4A3</td><td class="red">G5A3</td></tr>
</table>

<h3>Follow-up Plan</h3>
<p>Continue kidney protective medications</p>
<div class="inline">
  <label>Follow-up Visit In:
    <select id="visitFollowup">
      <option value="1 month">1 month</option>
      <option value="2 months">2 months</option>
      <option value="3 months">3 months</option>
      <option value="6 months">6 months</option>
    </select>
  </label>
  <label>Repeat labs in:
    <select id="repeatLabs">
      <option value="1 month">1 month</option>
      <option value="2 months">2 months</option>
      <option value="3 months">3 months</option>
      <option value="6 months">6 months</option>
    </select>
  </label>
  <label>Vitamin D:
    <select id="vitaminD">
      <option value="2000 units">2000 units</option>
      <option value="5000 units">5000 units</option>
      <option value="Prescribed">Prescribed</option>
    </select>
  </label>
  <label>Salt Restriction:
    <select id="saltRestriction">
      <option value="2 gm or less">2 gm or less</option>
      <option value="Liberalized">Liberalized</option>
    </select>
  </label>
  <label>Fluid Restriction:
    <select id="fluidRestriction">
      <option value="42 oz">42 oz</option>
      <option value="60 oz">60 oz</option>
      <option value="No limit">No limit</option>
    </select>
  </label>
  <label>Potassium Restriction:
    <select id="kRestriction">
      <option value="< 3 gm">&lt; 3 gm</option>
      <option value="No limit">No limit</option>
    </select>
  </label>
</div>

<button id="exportBtn" onclick="exportToPDF()">Export to PDF</button>


<script>
const backgroundBands = {
  id: 'ckdBands',
  beforeDraw: (chart) => {
    const ctx = chart.ctx;
    const yAxis = chart.scales.y;
    const chartArea = chart.chartArea;
    const zones = [
      { min: 0, max: 15, color: '#cc0000' },     // Stage 5
      { min: 15, max: 30, color: '#ff6666' },    // Stage 4
      { min: 30, max: 45, color: '#ffc78a' },    // Stage 3b
      { min: 45, max: 60, color: '#fff79a' }     // Stage 3a
    ];
    zones.forEach(zone => {
      const yTop = yAxis.getPixelForValue(zone.max);
      const yBottom = yAxis.getPixelForValue(zone.min);
      ctx.save();
      ctx.fillStyle = zone.color;
      ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBottom - yTop);
      ctx.restore();
    });
  }
};

Chart.register(backgroundBands);
</script>

<script>
let gfrChart, uacrChart, creatinineChart;

function parseAndPlot() {
  const input = document.getElementById("labInput").value;
  const lines = input.split(/\n|;/);
  const dates = [], gfrs = [], uacrs = [], creats = [], dateObjs = [];

  lines.forEach(line => {
    const dateMatch = line.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
    const gfrMatch = line.match(/\b(?:e?GFR)[:=\-]?\s*(\d{1,3})/i);
    const uacrMatch = line.match(/UACR[:=\-]?\s*(\d{1,5})/i);
    const creatMatch = line.match(/creatinine[:=\-]?\s*(\d{1,2}\.\d+)/i);
    if (dateMatch) {
      const dateStr = dateMatch[1];
      const parsedDate = new Date(dateStr);
      if (!isNaN(parsedDate)) {
        dateObjs.push(parsedDate);
        dates.push(dateStr);
        gfrs.push(gfrMatch ? parseInt(gfrMatch[1]) : null);
        uacrs.push(uacrMatch ? parseInt(uacrMatch[1]) : null);
        creats.push(creatMatch ? parseFloat(creatMatch[1]) : null);
      }
    }
  });

  const summary = summarizeData(gfrs, uacrs, dateObjs, creats);
  document.getElementById("parsedSummary").innerText = summary;
  highlightKDIGO(gfrs, uacrs);
  plotCharts(dates.reverse(), gfrs.reverse(), uacrs.reverse(), creats.reverse());
}

function summarizeData(gfrs, uacrs, dateObjs, creats) {
  let s = "";
  const latestGFR = gfrs.filter(v => v !== null).slice(-1)[0];
  const latestUACR = uacrs.filter(v => v !== null).slice(-1)[0];
  if (latestGFR !== undefined) {
    s += "CKD Stage: " + (latestGFR >= 90 ? "1" : latestGFR >= 60 ? "2" : latestGFR >= 45 ? "3a" : latestGFR >= 30 ? "3b" : latestGFR >= 15 ? "4" : "5");
  }
  if (latestUACR !== undefined) {
    s += ` | Albuminuria: ${latestUACR < 30 ? "A1" : latestUACR <= 300 ? "A2" : "A3"}`;
  }

  // Baseline creatinine over last 6 months
  const now = new Date();
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(now.getMonth() - 6);
  const recentCr = creats
    .map((val, i) => ({ val, d: dateObjs[i] }))
    .filter(entry => entry.val && entry.d && entry.d >= sixMonthsAgo)
    .map(entry => entry.val);

  if (recentCr.length >= 1) {
    const avgCr = (recentCr.reduce((a, b) => a + b) / recentCr.length).toFixed(2);
    s += ` | Baseline Creatinine (6 mo): ${avgCr}`;
  }

  return s;
}

function plotCharts(dates, gfrs, uacrs, creats) {
  dates.reverse();
  gfrs.reverse();
  uacrs.reverse();
  creats.reverse();
  const gctx = document.getElementById("gfrChart").getContext("2d");
  const uctx = document.getElementById("uacrChart").getContext("2d");
  const cctx = document.getElementById("creatinineChart").getContext("2d");

  if (gfrChart) gfrChart.destroy();
  if (uacrChart) uacrChart.destroy();
  if (creatinineChart) creatinineChart.destroy();

  const gfrColors = gfrs.map(g => {
    if (g >= 45 && g < 60) return "yellow";
    if (g >= 30 && g < 45) return "orange";
    if (g < 30) return "red";
    return "blue";
  });

  gfrChart = new Chart(gctx, {
    plugins: [backgroundBands],
    type: "line",
    data: { labels: dates, datasets: [{
      label: "GFR", data: gfrs, borderColor: "blue", backgroundColor: gfrColors, tension: 0.3, spanGaps: true }]},
    options: {
      scales: {
        x: { reverse: true, ticks: { font: { size: 14 } } },
        y: { beginAtZero: false, title: { display: true, text: 'GFR' }}
      }
    }
  });

  uacrChart = new Chart(uctx, {
    type: "line",
    data: { labels: dates, datasets: [{
      label: "UACR", data: uacrs, borderColor: "#000", backgroundColor: "rgba(0,0,0,0.08)", pointBackgroundColor: "#000", pointBorderColor: "#000", tension: 0.3, spanGaps: true }]},
    options: {
      scales: {
        x: { reverse: true, ticks: { font: { size: 14 } } },
        y: { beginAtZero: true, title: { display: true, text: 'UACR' }}
      }
    }
  });

  creatinineChart = new Chart(cctx, {
    type: "line",
    data: { labels: dates, datasets: [{
      label: "Creatinine", data: creats, borderColor: "#000", backgroundColor: "rgba(0,0,0,0.08)", pointBackgroundColor: "#000", pointBorderColor: "#000", tension: 0.3, spanGaps: true }]},
    options: {
      scales: {
        x: { reverse: true, ticks: { font: { size: 14 } } },
        y: { beginAtZero: false, title: { display: true, text: 'Creatinine (mg/dL)' }}
      }
    }
  });
}

async function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = document.getElementById("name").value;
  const date = document.getElementById("date").value;
  const followupVisit = document.getElementById("visitFollowup").value;
  const followup = document.getElementById("repeatLabs").value;
  const vitD = document.getElementById("vitaminD").value;
  const salt = document.getElementById("saltRestriction").value;
  const fluid = document.getElementById("fluidRestriction").value;
  const k = document.getElementById("kRestriction").value;
  const summary = document.getElementById("parsedSummary").innerText;

  doc.setFontSize(12);
  doc.text(`Kidney Care Plan`, 10, 10);
  doc.text(`Patient: ${name}`, 10, 20);
  doc.text(`Date: ${date}`, 10, 30);
  doc.text(`Summary: ${summary}`, 10, 40);
  doc.text(`Follow-up Visit In: ${followupVisit}`, 10, 50);
  doc.text(`Repeat Labs: ${followup}`, 10, 60);
  doc.text(`Vitamin D: ${vitD}`, 10, 70);
  doc.text(`Salt Restriction: ${salt}`, 10, 80);
  doc.text(`Fluid Restriction: ${fluid}`, 10, 90);
  doc.text(`Potassium Restriction: ${k}`, 10, 100);
  try {
    const logoImg = new Image();
    logoImg.src = 'nspc-logo.png?v=20250809v9';
    await new Promise((resolve)=>{ logoImg.onload = resolve; logoImg.onerror = resolve; });
    const pageWidth = doc.internal.pageSize.getWidth();
    const logoW = 60, logoH = 24;
    const x = (pageWidth - logoW) / 2;
    doc.addImage(logoImg, 'PNG', x, 10, logoW, logoH);
  } catch(e) {}


  
  const gfrCanvas = document.getElementById("gfrChart");
  const uacrCanvas = document.getElementById("uacrChart");
  const creatCanvas = document.getElementById("creatinineChart");

  try {
    if (window.gfrChart) { gfrChart.options.animation = false; gfrChart.update(); }
    if (window.uacrChart) { uacrChart.options.animation = false; uacrChart.update(); }
    if (window.creatinineChart) { creatinineChart.options.animation = false; creatinineChart.update(); }
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
  } catch(e) {}

  try { doc.addImage(gfrCanvas.toDataURL("image/png"), "PNG", 10, 110, 180, 40); } catch(e) {}
  try { doc.addImage(uacrCanvas.toDataURL("image/png"), "PNG", 10, 155, 180, 40); } catch(e) {}
  try { doc.addImage(creatCanvas.toDataURL("image/png"), "PNG", 10, 200, 180, 40); } catch(e) {}

  doc.save("kidney_care_plan.pdf");
}
</script>

<script>
function highlightKDIGO(gfrs, uacrs) {
  const kdigoTable = document.getElementById("heatmapTable");
  let gfr = gfrs.filter(v => v !== null).pop();
  let uacr = uacrs.filter(v => v !== null).pop();
  if (gfr == null || uacr == null) return;

  let gStage = gfr >= 90 ? 1 : gfr >= 60 ? 2 : gfr >= 45 ? 3 : gfr >= 30 ? 4 : gfr >= 15 ? 5 : 6;
  let aStage = uacr < 30 ? 1 : uacr <= 300 ? 2 : 3;

  const cellMap = {
    "1_1": [1,1], "2_1": [1,2], "3_1": [1,3], "4_1": [1,4], "5_1": [1,5], "6_1": [1,6],
    "1_2": [2,1], "2_2": [2,2], "3_2": [2,3], "4_2": [2,4], "5_2": [2,5], "6_2": [2,6],
    "1_3": [3,1], "2_3": [3,2], "3_3": [3,3], "4_3": [3,4], "5_3": [3,5], "6_3": [3,6]
  };

  const key = `${gStage}_${aStage}`;
  if (cellMap[key]) {
    const [row, col] = cellMap[key];
    kdigoTable.rows[row].cells[col].innerHTML += " ←";
  }
}
</script>

</body>
</html>
