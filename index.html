<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kidney Care Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{ --card:#f8fbff; --ink:#2c3e50; --muted:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f7fbfd; margin: 20px; color:var(--ink); }
    h1 { text-align: center; color: #2c3e50; margin:8px 0 2px; font-size: 24px; }
    input, select, textarea, button { width: 100%; padding: 8px; margin: 6px 0; font-size: 14px; border-radius:8px; border:1px solid #cbd5e1; }
    label { font-weight: 600; display: block; margin-top: 10px; }
    .chart-container { width: 100%; margin-top: 12px; background: #fff; border-radius: 12px; box-shadow: 0 1px 0 rgba(0,0,0,0.04) inset; padding:8px; }
    canvas { background: #fff; border-radius: 8px; height: 180px !important; }
    .inline { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 10px; }
    #heatmapTable { border-collapse: collapse; margin-top: 20px; width: 100%; background:#fff; border-radius: 12px; overflow:hidden; }
    #heatmapTable td, #heatmapTable th { padding: 6px; text-align: center; border: 1px solid #aaa; font-weight: 600; font-size: 13px;}
    .green { background-color: #b6ffb6; }
    .yellow { background-color: #fff79a; }
    .orange { background-color: #ffc78a; }
    .red { background-color: #ff7b7b; }
    #exportBtn { background: #0ea5e9; border:0; color: white; font-size: 16px; margin-top: 16px; border-radius:10px; padding:10px 14px; }
    .muted { color:var(--muted); font-weight:500; }
  </style>
</head>
<body>
<img src="nspc-logo.png?v=20250811" alt="NSPC Logo" style="width:180px; display:block; margin:10px auto 0;" />
<h1>Kidney Care Plan</h1>

<label>Patient Name</label>
<input type="text" id="name" placeholder="Enter full name" />
<label>Date</label>
<input type="date" id="date" />

<label>Paste Lab Notes or Text</label>
<textarea id="labInput" rows="6" placeholder="e.g. 06/01/2024 - creatinine 1.2, GFR 57, UACR 120..."></textarea>
<button onclick="parseAndPlot()">Parse and Plot Charts</button>

<div id="parsedSummary" style="font-weight:700; margin:10px 0;"></div>
<div class="chart-container"><canvas id="gfrChart"></canvas></div>
<div class="chart-container"><canvas id="creatinineChart"></canvas></div>
<div class="chart-container"><canvas id="uacrChart"></canvas></div>

<!-- Hidden CKD Classification image to embed into PDF export -->
<img id="ckdChartImg" src="IMG_9350.jpeg" alt="CKD Classification Chart" style="display:none; max-width:100%;" />

<h3 class="muted">KDIGO Risk Heat Map (Patient Cell Arrow)</h3>
<table id="heatmapTable">
  <tr><th>UACR ↓ / GFR →</th><th>≥ 90</th><th>60–89</th><th>45–59</th><th>30–44</th><th>15–29</th><th>&lt;15</th></tr>
  <tr><th>&lt; 30 (A1)</th><td class="green">G1A1</td><td class="green">G2A1</td><td class="yellow">G3aA1</td><td class="yellow">G3bA1</td><td class="orange">G4A1</td><td class="red">G5A1</td></tr>
  <tr><th>30–300 (A2)</th><td class="yellow">G1A2</td><td class="yellow">G2A2</td><td class="orange">G3aA2</td><td class="orange">G3bA2</td><td class="red">G4A2</td><td class="red">G5A2</td></tr>
  <tr><th>&gt; 300 (A3)</th><td class="orange">G1A3</td><td class="orange">G2A3</td><td class="red">G3aA3</td><td class="red">G3bA3</td><td class="red">G4A3</td><td class="red">G5A3</td></tr>
</table>

<h3>Follow-up Plan</h3>
<p>Continue kidney protective medications</p>
<div class="inline">
  <label>Follow-up Visit In:
    <select id="visitFollowup">
      <option>1 month</option><option>2 months</option><option>3 months</option><option selected>6 months</option>
    </select>
  </label>
  <label>Repeat labs in:
    <select id="repeatLabs">
      <option>1 month</option><option>2 months</option><option>3 months</option><option selected>6 months</option>
    </select>
  </label>
  <label>Vitamin D dose:
    <select id="vitaminD">
      <option>Hold</option><option selected>2000 IU daily</option><option>5000 IU daily</option><option>Stop</option>
    </select>
  </label>
  <label>Vitamin D supplementation:
    <select id="vitDSupp">
      <option>Start</option><option selected>Continue</option><option>No</option>
    </select>
  </label>
  <label>BP Goal:
    <select id="bpGoal">
      <option>&lt;120/80</option><option>&lt;130/80</option><option>&lt;140/80</option>
    </select>
  </label>
  <label>Salt Restriction:
    <select id="saltRestriction">
      <option selected>2 gm or less</option><option>Liberalized</option>
    </select>
  </label>
  <label>Fluid Restriction:
    <select id="fluidRestriction">
      <option>42 oz</option><option selected>60 oz</option><option>No limit</option>
    </select>
  </label>
  <label>Potassium Restriction:
    <select id="kRestriction">
      <option>&lt; 3 gm</option><option>No limit</option>
    </select>
  </label>
</div>

<button id="exportBtn" onclick="exportToPDF()">Export to PDF</button>

<script>
// CKD bands plugin draws only on GFR chart
const backgroundBands = {
  id: 'ckdBands',
  beforeDatasetsDraw(chart) {
    if (chart.canvas.id !== 'gfrChart') return;
    const {ctx, chartArea, scales:{y}} = chart;
    const zones = [
      {min: 0,  max: 15, color: '#cc0000'}, // G5 deep red
      {min: 15, max: 30, color: '#ff6666'}, // G4 red
      {min: 30, max: 45, color: '#ffc78a'}, // G3b orange
      {min: 45, max: 60, color: '#fff79a'}, // G3a yellow
    ];
    zones.forEach(z=>{
      const yTop = y.getPixelForValue(z.max), yBot = y.getPixelForValue(z.min);
      ctx.save(); ctx.fillStyle = z.color;
      ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBot - yTop);
      ctx.restore();
    });
  }
};
Chart.register(backgroundBands);
</script>

<script>
let gfrChart, uacrChart, creatinineChart;

function parseAndPlot() {
  const input = document.getElementById("labInput").value;
  const lines = input.split(/\n|;/);
  const dates = [], gfrs = [], uacrs = [], creats = [], dateObjs = [];

  lines.forEach(line => {
    const dateMatch = line.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
    const gfrMatch = line.match(/\b(?:e?GFR)[:=\-]?\s*(\d{1,3})/i);
    const uacrMatch = line.match(/UACR[:=\-]?\s*(\d{1,5})/i);
    const creatMatch = line.match(/creatinine[:=\-]?\s*(\d{1,2}\.\d+)/i);
    if (dateMatch) {
      const dateStr = dateMatch[1];
      const parsedDate = new Date(dateStr);
      if (!isNaN(parsedDate)) {
        dateObjs.push(parsedDate);
        dates.push(dateStr);
        gfrs.push(gfrMatch ? parseInt(gfrMatch[1]) : null);
        uacrs.push(uacrMatch ? parseInt(uacrMatch[1]) : null);
        creats.push(creatMatch ? parseFloat(creatMatch[1]) : null);
      }
    }
  });

  const summary = summarizeData(gfrs, uacrs, dateObjs, creats);
  document.getElementById("parsedSummary").innerText = summary;
  highlightKDIGO(gfrs, uacrs);
  plotCharts(dates.reverse(), gfrs.reverse(), uacrs.reverse(), creats.reverse());
}

function summarizeData(gfrs, uacrs, dateObjs, creats) {
  let s = "";
  const latestGFR = gfrs.filter(v => v !== null).slice(-1)[0];
  const latestUACR = uacrs.filter(v => v !== null).slice(-1)[0];
  if (latestGFR !== undefined) {
    s += "CKD Stage: " + (latestGFR >= 90 ? "1" : latestGFR >= 60 ? "2" : latestGFR >= 45 ? "3a" : latestGFR >= 30 ? "3b" : latestGFR >= 15 ? "4" : "5");
  }
  if (latestUACR !== undefined) {
    s += ` | Albuminuria: ${latestUACR < 30 ? "A1" : latestUACR <= 300 ? "A2" : "A3"}`;
  }

  // Baseline creatinine over last 6 months
  const now = new Date();
  const sixMonthsAgo = new Date();
  sixMonthsAgo.setMonth(now.getMonth() - 6);
  const recentCr = creats
    .map((val, i) => ({ val, d: dateObjs[i] }))
    .filter(entry => entry.val && entry.d && entry.d >= sixMonthsAgo)
    .map(entry => entry.val);

  if (recentCr.length >= 1) {
    const avgCr = (recentCr.reduce((a, b) => a + b) / recentCr.length).toFixed(2);
    s += ` | Baseline Creatinine (6 mo): ${avgCr}`;
  }

  return s;
}

function plotCharts(dates, gfrs, uacrs, creats) {
  // reverse again so most recent on right in UI
  dates.reverse(); gfrs.reverse(); uacrs.reverse(); creats.reverse();

  const gctx = document.getElementById("gfrChart").getContext("2d");
  const uctx = document.getElementById("uacrChart").getContext("2d");
  const cctx = document.getElementById("creatinineChart").getContext("2d");

  if (gfrChart) gfrChart.destroy();
  if (uacrChart) uacrChart.destroy();
  if (creatinineChart) creatinineChart.destroy();

  // Auto-tight y range for GFR with margins
  const gValues = gfrs.filter(v=>v!=null);
  let ymin = Math.min(...gValues); let ymax = Math.max(...gValues);
  if (!isFinite(ymin) || !isFinite(ymax)) { ymin=0; ymax=60; }
  const margin = 3;
  ymin = Math.max(0, Math.floor((ymin - margin)));
  ymax = Math.min(60, Math.ceil((ymax + margin)));

  gfrChart = new Chart(gctx, {
    plugins: [backgroundBands],
    type: "line",
    data: { labels: dates, datasets: [{
      label: "GFR", data: gfrs, borderColor: "#1d4ed8", backgroundColor: "rgba(29,78,216,0.08)",
      tension: 0.35, spanGaps: true, pointRadius: 3, pointBackgroundColor:"#1d4ed8", pointBorderColor:"#1d4ed8"}]},
    options: { plugins: { legend: { labels: { color: '#374151' } } },
      scales: {
        x: { reverse: true, ticks: { font: { size: 12 }, color: '#6b7280' }, grid: { color: '#e5e7eb' } },
        y: { min: ymin, max: ymax, title: { display: true, text: 'GFR' }, ticks:{ color:'#6b7280' }, grid:{ color:'#e5e7eb' } }
      }
    }
  });

  // Grayscale charts
  creatinineChart = new Chart(cctx, {
    type: "line",
    data: { labels: dates, datasets: [{
      label: "Creatinine", data: creats, borderColor: "#111111", backgroundColor: "rgba(0,0,0,0.08)",
      pointBackgroundColor: "#111111", pointBorderColor: "#111111", tension: 0.35, spanGaps: true, pointRadius: 3 }]},
    options: {
      scales: {
        x: { reverse: true, ticks: { font: { size: 12 }, color: '#6b7280' }, grid: { color: '#e5e7eb' } },
        y: { beginAtZero: false, title: { display: true, text: 'Creatinine (mg/dL)' }, ticks:{ color:'#6b7280' }, grid:{ color:'#e5e7eb' } }
      }
    }
  });

  uacrChart = new Chart(uctx, {
    type: "line",
    data: { labels: dates, datasets: [{
      label: "UACR", data: uacrs, borderColor: "#111111", backgroundColor: "rgba(0,0,0,0.08)",
      pointBackgroundColor: "#111111", pointBorderColor: "#111111", tension: 0.35, spanGaps: true, pointRadius: 3 }]},
    options: { plugins: { legend: { labels: { color: '#374151' } } }, 
      scales: {
        x: { reverse: true, ticks: { font: { size: 12 }, color: '#6b7280' }, grid: { color: '#e5e7eb' } },
        y: { beginAtZero: true, title: { display: true, text: 'UACR' }, ticks:{ color:'#6b7280' }, grid:{ color:'#e5e7eb' } }
      }
    }
  });
}

// Utility to convert image element -> dataURL with same-origin safety
async function toDataURLFromImageElement(imgEl, type='image/jpeg', quality=0.92){
  await new Promise((resolve) => {
    if (imgEl.complete) resolve(); else { imgEl.onload = resolve; imgEl.onerror = resolve; }
  });
  const c = document.createElement('canvas');
  c.width = imgEl.naturalWidth; c.height = imgEl.naturalHeight;
  const ctx = c.getContext('2d');
  ctx.drawImage(imgEl, 0,0);
  return c.toDataURL(type, quality);
}

async function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = 10;
  let y = margin;

  const name = document.getElementById("name").value || "";
  const date = document.getElementById("date").value || "";
  const followupVisit = document.getElementById("visitFollowup").value;
  const followup = document.getElementById("repeatLabs").value;
  const vitD = document.getElementById("vitaminD").value;
  const vitDSupp = document.getElementById("vitDSupp").value;
  const bpGoal = document.getElementById("bpGoal").value;
  const salt = document.getElementById("saltRestriction").value;
  const fluid = document.getElementById("fluidRestriction").value;
  const k = document.getElementById("kRestriction").value;
  const summary = document.getElementById("parsedSummary").innerText || "";

  // Header: centered NSPC logo
  try {
    const logoImg = new Image();
    logoImg.src = 'nspc-logo.png?v=20250811';
    await new Promise((resolve)=>{ logoImg.onload = resolve; logoImg.onerror = resolve; });
    const logoW = 46, logoH = 18;
    const centerX = (pageWidth - logoW) / 2;
    doc.addImage(logoImg, 'PNG', centerX, y, logoW, logoH);
    y += logoH + 4;
  } catch(e) { y += 4; }

  // Title
  doc.setFontSize(15);
  doc.text('Kidney Care Plan', pageWidth/2, y+6, { align: 'center' });
  y += 12;

  // Info block with wrapping
  doc.setFontSize(10);
  const infoLines = [
    `Patient: ${name}`,
    `Date: ${date}`,
    `Summary: ${summary}`,
    `Follow-up Visit In: ${followupVisit}    Repeat Labs: ${followup}`,
    `Vitamin D: ${vitD} (Supp: ${vitDSupp})    BP Goal: ${bpGoal}`,
    `Salt: ${salt}    Fluid: ${fluid}    Potassium: ${k}`
  ];
  const maxWidth = pageWidth - margin*2;
  let totalInfoLines = 0;
  infoLines.forEach(txt => {
    const wrapped = doc.splitTextToSize(txt, maxWidth);
    doc.text(wrapped, margin, y);
    y += wrapped.length * 4.6;
    totalInfoLines += wrapped.length;
  });
  y += 2; // small spacer

  // Compute remaining height and scale chart heights to fit
  const bottomMargin = 8;
  const remaining = pageHeight - bottomMargin - y;
  // Allocate heights: 3 charts + CKD image (weight 1.6)
  const weightCharts = 3; const weightCkd = 1.6;
  const unit = remaining / (weightCharts + weightCkd + 0.0); // no extra gaps counted separately
  const chartH = Math.max(22, Math.min(34, unit)); // clamp nice range
  const ckdH = Math.max(30, Math.min(52, unit*weightCkd));
  const imgW = pageWidth - margin*2;

  const gfrCanvas = document.getElementById("gfrChart");
  const creatCanvas = document.getElementById("creatinineChart");
  const uacrCanvas = document.getElementById("uacrChart");

  doc.addImage(gfrCanvas.toDataURL("image/png"), "PNG", margin, y, imgW, chartH); y += chartH + 3;
  doc.addImage(creatCanvas.toDataURL("image/png"), "PNG", margin, y, imgW, chartH); y += chartH + 3;
  doc.addImage(uacrCanvas.toDataURL("image/png"), "PNG", margin, y, imgW, chartH); y += chartH + 3;

  // CKD image (preload & convert to dataURL for safety)
  try {
    const ckdEl = document.getElementById('ckdChartImg');
    const ckdDataUrl = await toDataURLFromImageElement(ckdEl, 'image/jpeg', 0.92);
    doc.addImage(ckdDataUrl, 'JPEG', margin, y, imgW, ckdH);
  } catch(e) { /* ignore */ }

  doc.save("kidney_care_plan.pdf");
}
</script>

<script>
function highlightKDIGO(gfrs, uacrs) {
  const kdigoTable = document.getElementById("heatmapTable");
  let gfr = gfrs.filter(v => v !== null).pop();
  let uacr = uacrs.filter(v => v !== null).pop();
  if (gfr == null || uacr == null) return;

  let gStage = gfr >= 90 ? 1 : gfr >= 60 ? 2 : gfr >= 45 ? 3 : gfr >= 30 ? 4 : gfr >= 15 ? 5 : 6;
  let aStage = uacr < 30 ? 1 : uacr <= 300 ? 2 : 3;

  const cellMap = {
    "1_1": [1,1], "2_1": [1,2], "3_1": [1,3], "4_1": [1,4], "5_1": [1,5], "6_1": [1,6],
    "1_2": [2,1], "2_2": [2,2], "3_2": [2,3], "4_2": [2,4], "5_2": [2,5], "6_2": [2,6],
    "1_3": [3,1], "2_3": [3,2], "3_3": [3,3], "4_3": [3,4], "5_3": [3,5], "6_3": [3,6]
  };

  const key = `${gStage}_${aStage}`;
  if (cellMap[key]) {
    const [row, col] = cellMap[key];
    kdigoTable.rows[row].cells[col].innerHTML += " ←";
  }
}
</script>
</body>
</html>
