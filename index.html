
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Kidney Care Plan (NSPC)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div id="pdf-content">
<img alt="NSPC Logo" src="nspc-logo.png" style="width:150px; margin-bottom:20px;"/>
<h2>Kidney Care Plan</h2>
<label>Patient Name</label><br/>
<input id="patientName" type="text"/><br/>
<label>Date</label><br/>
<input id="planDate" type="date" value="2025-07-26"/><br/>
<label>Paste Lab Notes or Text</label><br/>
<textarea cols="80" id="labInput" rows="10"></textarea><br/>
<button onclick="parseAndPlot()">Parse and Plot Charts</button><br/><br/>
<div id="charts">
<h3>GFR Chart</h3>
<canvas id="gfrChart" style="width:100%; max-height:300px;"></canvas>
<h3>Creatinine Chart</h3>
<canvas id="creatinineChart" style="width:100%; max-height:300px;"></canvas>
<h3>UACR Chart</h3>
<canvas id="uacrChart" style="width:100%; max-height:300px;"></canvas>
</div>
<br/>
<div id="parsedSummary" style="font-weight: bold; margin-top: 20px;"></div>
<h3>Follow-up Plan</h3>
<label>Follow-up Visit In:</label>
<select>
<option>1 month</option>
<option>3 months</option>
<option>6 months</option>
</select><br/>
<label>Repeat labs in:</label>
<select>
<option>1 month</option>
<option>3 months</option>
<option>6 months</option>
</select><br/>
<label>Vitamin D:</label>
<select>
<option>2000 units</option>
<option>1000 units</option>
<option>None</option>
</select><br/>
<label>Salt Restriction:</label>
<select>
<option>2 gm or less</option>
<option>Liberalized</option>
</select><br/>
<label>Fluid Restriction:</label>
<select>
<option>42 oz</option>
<option>60 oz</option>
</select><br/>
<label>Potassium Restriction:</label>
<select>
<option>&lt; 3 gm</option>
<option>No limit</option>
</select><br/>
<h3>KDIGO Risk Heat Map (Patient Cell Arrow)</h3>
<table border="1" id="kdigo-grid" style="border-collapse: collapse; text-align: center;">
<tr><th>UACR ↓ / GFR →</th><th>≥ 90</th><th>60–89</th><th>45–59</th><th>30–44</th><th>15–29</th><th>&lt;15</th></tr>
<tr><th>&lt; 30 (A1)</th><td id="G1A1">G1A1</td><td id="G2A1">G2A1</td><td id="G3aA1">G3aA1</td><td id="G3bA1">G3bA1</td><td id="G4A1">G4A1</td><td id="G5A1">G5A1</td></tr>
<tr><th>30–300 (A2)</th><td id="G1A2">G1A2</td><td id="G2A2">G2A2</td><td id="G3aA2">G3aA2</td><td id="G3bA2">G3bA2</td><td id="G4A2">G4A2</td><td id="G5A2">G5A2</td></tr>
<tr><th>&gt; 300 (A3)</th><td id="G1A3">G1A3</td><td id="G2A3">G2A3</td><td id="G3aA3">G3aA3</td><td id="G3bA3">G3bA3</td><td id="G4A3">G4A3</td><td id="G5A3">G5A3</td></tr>
</table>

<br/>
<button onclick="exportPDF()">Export to PDF</button>
</div>
<script>
    let gfrChart, creatinineChart, uacrChart;

    function parseAndPlot() {
      const input = document.getElementById("labInput").value;
      const lines = input.split(/\n|;/);
      const dates = [], gfrs = [], creats = [], uacrs = [];

      lines.forEach(line => {
        const dateMatch = line.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
        const gfrMatch = line.match(/GFR[:=\-]?\s*(\d{1,3})/i);
        const creatMatch = line.match(/creatinine[:=\-]?\s*(\d{1,2}\.\d+)/i);
        const uacrMatch = line.match(/UACR[:=\-]?\s*(\d{1,5})/i);
        if (dateMatch) {
          dates.push(dateMatch[1]);
          gfrs.push(gfrMatch ? parseInt(gfrMatch[1]) : null);
          creats.push(creatMatch ? parseFloat(creatMatch[1]) : null);
          uacrs.push(uacrMatch ? parseInt(uacrMatch[1]) : null);
        }
      });

      renderCharts(dates.reverse(), gfrs.reverse(), creats.reverse(), uacrs.reverse());
    }

    function renderCharts(labels, gfrs, creats, uacrs) {
      if (gfrChart) gfrChart.destroy();
      if (creatinineChart) creatinineChart.destroy();
      if (uacrChart) uacrChart.destroy();

      gfrChart = new Chart(document.getElementById("gfrChart").getContext("2d"), {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "GFR",
            data: gfrs,
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            borderColor: "rgba(54, 162, 235, 1)",
            fill: true,
            tension: 0.3
          }]
        }
      });

      creatinineChart = new Chart(document.getElementById("creatinineChart").getContext("2d"), {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Creatinine",
            data: creats,
            fill: false,
            tension: 0.3
          }]
        }
      });

      uacrChart = new Chart(document.getElementById("uacrChart").getContext("2d"), {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "UACR",
            data: uacrs,
            fill: false,
            tension: 0.3
          }]
        }
      });
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.text("Kidney Care Plan", 10, 10);
      const logo = document.querySelector("img");
      const canvas1 = document.getElementById("gfrChart");
      const canvas2 = document.getElementById("creatinineChart");
      const canvas3 = document.getElementById("uacrChart");

      if (logo && logo.src.startsWith("data:")) {
        doc.addImage(logo.src, "PNG", 10, 15, 50, 20);
      }

      if (canvas1) {
        doc.addPage();
        doc.text("GFR Chart", 10, 10);
        doc.addImage(canvas1.toDataURL("image/png"), "PNG", 10, 20, 180, 80);
      }

      if (canvas2) {
        doc.addPage();
        doc.text("Creatinine Chart", 10, 10);
        doc.addImage(canvas2.toDataURL("image/png"), "PNG", 10, 20, 180, 80);
      }

      if (canvas3) {
        doc.addPage();
        doc.text("UACR Chart", 10, 10);
        doc.addImage(canvas3.toDataURL("image/png"), "PNG", 10, 20, 180, 80);
      }

      doc.save("KidneyCarePlan.pdf");
    }
  

function highlightKDIGO(gfr, uacr) {
  // Clear previous highlights
  document.querySelectorAll("#kdigo-grid td").forEach(td => td.style.backgroundColor = "");
  const latestGFR = gfr.filter(x => x !== null).at(-1);
  const latestUACR = uacr.filter(x => x !== null).at(-1);
  if (!latestGFR || !latestUACR) return;

  let gStage = latestGFR >= 90 ? "G1" :
               latestGFR >= 60 ? "G2" :
               latestGFR >= 45 ? "G3a" :
               latestGFR >= 30 ? "G3b" :
               latestGFR >= 15 ? "G4" : "G5";

  let aStage = latestUACR < 30 ? "A1" :
               latestUACR <= 300 ? "A2" : "A3";

  let cell = document.getElementById(gStage + aStage);
  if (cell) cell.style.backgroundColor = "gold";
}

function calculateSlope(values, dates) {
  if (values.length < 4) return null;
  const points = values.map((v, i) => v !== null ? { x: dates[i], y: v } : null).filter(p => p !== null);
  if (points.length < 4) return null;
  let n = points.length;
  let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
  for (let i = 0; i < n; i++) {
    let x = (points[i].x - points[0].x) / (1000 * 60 * 60 * 24 * 365);
    let y = points[i].y;
    sumX += x;
    sumY += y;
    sumXY += x * y;
    sumX2 += x * x;
  }
  let slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
  return slope.toFixed(1);
}

function parseAndPlot() {
  const input = document.getElementById("labInput").value;
  const lines = input.split(/\n|;/);
  const dates = [], gfrs = [], creats = [], uacrs = [], dateObjs = [];

  lines.forEach(line => {
    const dateMatch = line.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
    const gfrMatch = line.match(/GFR[:=\-]?\s*(\d{1,3})/i);
    const creatMatch = line.match(/creatinine[:=\-]?\s*(\d{1,2}\.\d+)/i);
    const uacrMatch = line.match(/UACR[:=\-]?\s*(\d{1,5})/i);
    if (dateMatch) {
      const d = new Date(dateMatch[1]);
      if (!isNaN(d)) {
        dateObjs.push(d);
        dates.push(dateMatch[1]);
        gfrs.push(gfrMatch ? parseInt(gfrMatch[1]) : null);
        creats.push(creatMatch ? parseFloat(creatMatch[1]) : null);
        uacrs.push(uacrMatch ? parseInt(uacrMatch[1]) : null);
      }
    }
  });

  highlightKDIGO(gfrs, uacrs);

  let latestGFR = gfrs.filter(x => x !== null).at(-1);
  let latestUACR = uacrs.filter(x => x !== null).at(-1);
  let gStage = latestGFR >= 90 ? "1" :
               latestGFR >= 60 ? "2" :
               latestGFR >= 45 ? "3a" :
               latestGFR >= 30 ? "3b" :
               latestGFR >= 15 ? "4" : "5";
  let aStage = latestUACR < 30 ? "A1" :
               latestUACR <= 300 ? "A2" : "A3";

  let slope = calculateSlope(gfrs, dateObjs);
  let summary = `CKD Stage: ${gStage} | Albuminuria: ${aStage}`;
  if (slope) summary += ` | GFR slope: ${slope} mL/min/yr`;
  document.getElementById("parsedSummary").innerText = summary;

  renderCharts(dates.reverse(), gfrs.reverse(), creats.reverse(), uacrs.reverse());
}
</script>
</body>
</html>
